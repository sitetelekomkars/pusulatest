const TECH_DOC_CONTENT = {
    "broadcast": [
        { "title": "Smart TV ‚Äì Canlƒ± Yayƒ±nda Donma Problemi Ya≈üƒ±yorum", "body": "M√º≈üterinin sorun ya≈üadƒ±ƒüƒ± yayƒ±n ya da yayƒ±nlarda genel bir sorun var mƒ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediƒüi y√∂n√ºnde bilgi verilir.\nM√º≈üterinin kullandƒ±ƒüƒ± cihaz TVmanager ‚Äòda loglardan kontrol edilir. Ar√ßelik/Beko/Grundig/Altus marka Android TV olmayan Smart TV‚Äôlerden ise genel sorun hakkƒ±nda bilgi verilir.\nYukarƒ±daki durumlar dƒ±≈üƒ±nda ya≈üanan bir sorun ise TV ve modemin elektrik baƒülantƒ±sƒ±nƒ± kesilip tekrar verilmesi istenir. ¬´ Ya≈üadƒ±ƒüƒ±nƒ±z sorunu kontrol ederken TV ve modeminizin elektrik baƒülantƒ±sƒ±nƒ± kesip 10 sn sonra yeniden a√ßabilir misiniz? Ardƒ±ndan yeniden yayƒ±nƒ± a√ßƒ±p kontrol edebilir misiniz? (Ayrƒ±ca √∂neri olarak modemi kapatƒ±p tekrar a√ßtƒ±ktan sonra, sadece izleme yaptƒ±ƒüƒ± cihaz modeme baƒülƒ± olursa daha iyi bir baƒülantƒ± olacaƒüƒ± bilgisi verilebilir)\nSorun devam eder ise Smart TV tarayƒ±cƒ±sƒ±ndan https://www.hiztesti.com.tr/ bir hƒ±z testi yapmasƒ± sonucu bizimle payla≈ümasƒ± istenir.\nHƒ±z testi sonucu 8 Mbps altƒ±nda ise internet baƒülantƒ± hƒ±zƒ±nƒ±n d√º≈ü√ºk olduƒüunu internet servis saƒülayƒ±cƒ±sƒ± ileti≈üime ge√ßmesi istenir.\n8 Mbps √ºzerinde ise m√º≈üteriden sorunu g√∂steren kƒ±sa bir video talep edilir.\nVideo kaydƒ± ve hƒ±z testinin sonu√ßlarƒ± g√∂steren bilgiler alƒ±ndƒ±ktan sonra m√º≈üteriye incelenmesi i√ßin teknik ekibimize iletildiƒüi inceleme tamamlandƒ±ƒüƒ±nda eposta ile bilgi verileceƒüi y√∂n√ºnde bilgi verilir.\nSorun aynƒ± g√ºn i√ßinde benzer cihazlarda farklƒ± m√º≈üterilerde ya≈üƒ±yor ise t√ºm bilgilerle Erlab‚Äôa arƒ±za kaydƒ± a√ßƒ±lƒ±r. Sorun birka√ß m√º≈üteri ile sƒ±nƒ±rlƒ± ise 17:00 ‚Äì 01:00 vardiyasƒ±ndaki ekip arkada≈üƒ±nda sistemsel bir sorun olmadƒ±ƒüƒ±na dair eposta g√∂nderilmesi i√ßin bilgileri payla≈üƒ±lƒ±r." },
        { "title": "Mobil Uygulama ‚Äì Canlƒ± Yayƒ±nda Donma Sorunu Ya≈üƒ±yorum", "body": "M√º≈üterinin sorun ya≈üadƒ±ƒüƒ± yayƒ±n ya da yayƒ±nlarda genel bir sorun var mƒ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediƒüi y√∂n√ºnde bilgi verilir.\nGenel bir sorun yok ise, www.hiztesti.com.tr link √ºzerinden hƒ±z testi yapmasƒ± sonucu bizimle payla≈ümasƒ± istenir.\nHƒ±z testi sonucu 8 mbps altƒ±nda ise internet baƒülantƒ± hƒ±zƒ±nƒ±n d√º≈ü√ºk olduƒüu internet servisi saƒülayƒ±cƒ±sƒ± ile ileti≈üime ge√ßmesi istenir.\n8 mbps √ºzerinde ise, uygulama verilerin temizlenmesi veya uygulamanƒ±n silip tekrar y√ºklenmesi istenilir, sorun devam etmesi durumunda sorunu g√∂steren video kaydƒ± istenir.\n4. Hƒ±z testi, cihaz marka model ve s√ºr√ºm bilgileri alƒ±ndƒ±ktan sonra, incelenmesi i√ßin teknik ekibe iletildiƒüi, inceleme tamamlandƒ±ƒüƒ±nda e-posta ile bilgi verileceƒüi y√∂n√ºnde bilgi verilir.\n5. Sorun aynƒ± g√ºn i√ßerinde benzer cihazlarda farklƒ± m√º≈üterilerde ya≈üƒ±yor ise t√ºm bilgilerle Erlab‚Äôa arƒ±za kaydƒ± a√ßƒ±lƒ±r. Sorun birka√ß m√º≈üteri ile sƒ±nƒ±rlƒ± ise 17:00 ‚Äì 01:00 vardiyasƒ±ndaki ekip arkada≈üƒ±nda sistemsel bir sorun olmadƒ±ƒüƒ±na dair eposta g√∂nderilmesi i√ßin bilgileri payla≈üƒ±lƒ±r." },
        { "title": "Bilgisayar ‚Äì Canlƒ± Yayƒ±nda Donma Sorunu Ya≈üƒ±yorum", "body": "M√º≈üterinin sorun ya≈üadƒ±ƒüƒ± yayƒ±n ya da yayƒ±nlarda genel bir sorun var mƒ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediƒüi y√∂n√ºnde bilgi verilir.\nGenel bir sorun deƒüilse, √∂ncelikle https://www.hiztesti.com.tr/ bir hƒ±z testi yapmasƒ± sonucu bizimle payla≈ümasƒ± istenir.\nHƒ±z testi sonucu 8 mbps altƒ±nda ise internet baƒülantƒ± hƒ±zƒ±nƒ±n d√º≈ü√ºk olduƒüunu internet servis saƒülayƒ±cƒ±sƒ± ileti≈üime ge√ßmesi istenir.\n8 mbps √ºzerinde ise m√º≈üteriden a≈üaƒüƒ±daki adƒ±mlarƒ± uygulamasƒ± istenir.\n3. Bilgisayarƒ±n i≈ületim sitemi √∂ƒürenilip, g√∂r√º≈üme √ºzerinden ‚Äò‚ÄôpingWindows7‚Äô‚Äô veya ‚Äò‚Äôpingwindows10‚Äô‚Äô kƒ±sayollarƒ±ndan m√º≈üteri sunucularƒ± kontrol edilir.\n4. Sunucu kontrol ekranƒ±nda kontrol edilmesi gereken, ok ile g√∂sterilen yerden, sunucu ile kayƒ±p olup olmadƒ±ƒüƒ± ve kƒ±rmƒ±zƒ± alan i√ßerisinde sunucu ile web sitemize ka√ß saniyede i≈ülem saƒüladƒ±ƒüƒ± kontrol edilir.\n5. 1 ‚Äì 35 arasƒ± normal sayƒ±labilir, bu saniye aralƒ±ƒüƒ±nda sorun ya≈üanƒ±yorsa, web sitemize daha hƒ±zlƒ± tepsi s√ºresi veren ve genellikle sorunsuz bir ≈üekilde izleme saƒülanabilen 193.192.103.249, 185.11.14.27 veya 195.175.178.8 sunucularƒ± kontrol edilmelidir.\n6. Uygun sunucuyu tespit ettikten sonra canlƒ± destek ekranƒ±nda ‚Äò‚ÄôHost‚Äô‚Äô ‚Äò‚Äôhost2‚Äô‚Äô kƒ±sa yollarƒ± kullanarak, kƒ±sa yoldaki adƒ±mlar ile m√º≈üterinin sadece bizim sitemize baƒülandƒ±ƒüƒ± sunucusunu, en uygun sunucu ile deƒüi≈ütirip tarayƒ±cƒ± a√ßƒ±p kapattƒ±rdƒ±ktan sonra tekrar yayƒ±nƒ± kontrol etmesini iletebiliriz.\n7. Sorun aynƒ± g√ºn i√ßerinde benzer i≈ületim sistemi veya sunucuda farklƒ± m√º≈üterilerde ya≈üƒ±yor ise t√ºm bilgilerle Erlab‚Äôa arƒ±za kaydƒ± a√ßƒ±lƒ±r. Sorun birka√ß m√º≈üteri ile sƒ±nƒ±rlƒ± ise 17:00 ‚Äì 01:00 vardiyasƒ±ndaki ekip arkada≈üƒ±nda sistemsel bir sorun olmadƒ±ƒüƒ±na dair eposta g√∂nderilmesi i√ßin bilgileri payla≈üƒ±lƒ±r" },
        { "title": "MacOS ‚Äì Canlƒ± Yayƒ±nda Donma Sorunu Ya≈üƒ±yorum", "body": "M√º≈üterinin sorun ya≈üadƒ±ƒüƒ± yayƒ±n ya da yayƒ±nlarda genel bir sorun var mƒ± kontrol edilir? Genel bir sorun var ise teknik ekibin incelediƒüi y√∂n√ºnde bilgi verilir.\nGenel bir sorun deƒüilse, √∂ncelikle https://www.hiztesti.com.tr/ bir hƒ±z testi yapmasƒ± sonucu bizimle payla≈ümasƒ± istenir.\nHƒ±z testi sonucu 8 mbps altƒ±nda ise internet baƒülantƒ± hƒ±zƒ±nƒ±n d√º≈ü√ºk olduƒüunu internet servis saƒülayƒ±cƒ±sƒ± ileti≈üime ge√ßmesi istenir.\n8 mbps √ºzerinde ise m√º≈üteriden a≈üaƒüƒ±daki adƒ±mlarƒ± uygulamasƒ± istenir.\nMindbehind √ºzerinden ‚Äò‚ÄôpingmacOS‚Äô‚Äô kƒ±sayolundan m√º≈üteri sunucularƒ± kontrol edilir.\nSunucu kontrol ekranƒ±nda kontrol edilmesi gereken, ‚Äò‚Äôpacket loss‚Äô‚Äô kƒ±smƒ±nda kayƒ±p olup olmadƒ±ƒüƒ±, alan i√ßerisinde sunucu ile web sitemize ka√ß saniyede i≈ülem saƒüladƒ±ƒüƒ± kontrol edilir.\n1 ‚Äì 35 arasƒ± normal sayƒ±labilir, bu saniye aralƒ±ƒüƒ±nda sorun ya≈üanƒ±yorsa, web sitemize daha hƒ±zlƒ± tepsi s√ºresi veren ve genellikle sorunsuz bir ≈üekilde izleme saƒülanabilen 193.192.103.249, 185.11.14.27 veya 195.175.178.8 sunucularƒ± kontrol edilmelidir.\nUygun sunucuyu tespit ettikten sonra canlƒ± destek ekranƒ±nda ‚Äò‚ÄômacOShost‚Äô‚Äô kƒ±sa yolunu kullanarak, kƒ±sa yoldaki adƒ±mlar ile m√º≈üterinin sadece bizim sitemize baƒülandƒ±ƒüƒ± sunucuyu, en uygun sunucu ile deƒüi≈ütirip tarayƒ±cƒ± a√ßƒ±p kapattƒ±rdƒ±ktan sonra tekrar yayƒ±nƒ± kontrol etmesini iletebiliriz.\nSorun aynƒ± g√ºn i√ßerinde benzer i≈ületim sistemi veya sunucuda farklƒ± m√º≈üterilerde ya≈üƒ±yor ise t√ºm bilgilerle Erlab‚Äôa arƒ±za kaydƒ± a√ßƒ±lƒ±r. Sorun birka√ß m√º≈üteri ile sƒ±nƒ±rlƒ± ise 17:00 ‚Äì 01:00 vardiyasƒ±ndaki ekip arkada≈üƒ±nda sistemsel bir sorun olmadƒ±ƒüƒ±na dair eposta g√∂nderilmesi i√ßin bilgileri payla≈üƒ±lƒ±r." },
        { "title": "‚Äò‚ÄôYayƒ±nda beklenmedik bir kesinti olu≈ütu‚Äô‚Äô Uyarƒ±sƒ±", "body": "Bu uyarƒ± genel bir yayƒ±n sorunu olduƒüunda ya da kullanƒ±cƒ± T√ºrkiye sƒ±nƒ±rlarƒ± dƒ±≈üƒ±nda bir yerden eri≈üim saƒüladƒ±ƒüƒ±nda kar≈üƒ±mƒ±za √ßƒ±kmaktadƒ±r.\nKullanƒ±cƒ±nƒ±n sorun ya≈üadƒ±ƒüƒ± yayƒ±n kontrol edilir ve genel bir yayƒ±n sorunu olup olmadƒ±ƒüƒ± teyit edilir.\nTvmanager‚Äôda SubscriberLog ekranƒ±ndan ip adresi alƒ±nƒ±r ve yurtdƒ±≈üƒ± bir konum olup olmadƒ±ƒüƒ± teyit edilir.\nKullanƒ±cƒ± yurtdƒ±≈üƒ±nda ise eri≈üim saƒülayamayacaƒüƒ± bilgisi verilir, VPN kullanƒ±yor ise kapatmasƒ± istenir.\nTVmanager Devices kƒ±smƒ±nda oturumlar sonlandƒ±rƒ±lƒ±r ve kullanƒ±cƒ±dan tekrar giri≈ü yaparak kontrol etmesi rica edilir.\nCihaz ve modem kapama ve a√ßma i≈ülemi uygulanƒ±r.\nSorun devam eder ise inceleme i√ßin cihaz ve diƒüer bilgilerle teknik ekibimize bilgi verileceƒüi iletilir." }
    ],
    "access": [
        { "title": "‚Äò‚ÄôLisans haklarƒ± sebebiyle T√ºrkiye sƒ±nƒ±rlarƒ± dƒ±≈üƒ±nda hizmet verilememektedir.‚Äô‚Äô Uyarƒ±sƒ±", "body": "Alƒ±nan hata m√º≈üterinin yurt dƒ±≈üƒ±nda olmasƒ± ve yurt i√ßinde ise VPN ya da benzeri bir uygulamanƒ±n cihazƒ±nda aktif olmasƒ±ndan kaynaklanmaktadƒ±r.\n\nM√º≈üteriye yurt dƒ±≈üƒ±nda olup olmadƒ±ƒüƒ± sorulur, yurt dƒ±≈üƒ±nda ise ‚Äò‚Äôlisans haklarƒ± sebebiyle yayƒ±nlarƒ±n yurt dƒ±≈üƒ±ndan izlenemediƒüi‚Äô‚Äô y√∂n√ºnde bilgi verilir.\nYurt i√ßinde ise VPN ya da benzeri bir uygulamanƒ±n cihazƒ±nda aktif olup ya da olmadƒ±ƒüƒ± sorulur. Aktif ise devre dƒ±≈üƒ± bƒ±rakƒ±lƒ±p tekrar denemesi √∂nerilir.\nVPN ya da benzeri bir uygulama kullanmƒ±yor ise m√º≈üterinin ip adresi √∂ƒürenilir ve https://tr.wizcase.com/tools/whats-my-ip/ ip adresi kontrol edilir. Aynƒ± zamanda adresin vpn √ºzerinden alƒ±nƒ±p alƒ±nmadƒ±ƒüƒ±nƒ±n kontrol√º i√ßin https://vpnapi.io adresine girilip kontrol edilir." },
        { "title": "‚Äò‚ÄôIP Karantina‚Äô‚Äô Uyarƒ±sƒ±", "body": "ƒ∞p Karantina sorunu genel bir sorun yok ise, eposta veya ≈üifre bir √ßok defa hatalƒ± girilmesinden dolayƒ± alƒ±nƒ±r.\nKullanƒ±cƒ±nƒ±n ip adresi karantina da olup ya da olmadƒ±ƒüƒ±, TVmanager ‚Äì CMS ‚Äì Admission Gate men√ºs√º √ºzerinden kontrol edilerek √ßƒ±karƒ±labilir. ƒ∞kinci bir se√ßenek olarak modem kapama ve a√ßma i≈ülemi yaptƒ±rƒ±labilir." }
    ],
    "app": [
        { "title": "Teknik Sorun Analizi Nasƒ±l Yapƒ±lƒ±r?", "body": "App Kaynaklƒ± Nedenler\nCihaz Kaynaklƒ± Nedenler\nApp hatalarƒ± ba≈ülƒ±ƒüƒ±nda uygulamanƒ±n a√ßƒ±lmamasƒ± ya da kendi kendine kapanmasƒ± ≈üeklinde teknik sorunlar ile kar≈üƒ±la≈üabiliriz.\nUygulamanƒ±n eski s√ºr√ºm√º\n√ñnbellek sorunlarƒ±\nUyumsuz cihazlar\nDolu RAM/Arka planda √ßalƒ±≈üan fazla uygulama\nCihazƒ±n g√ºncel olmamasƒ± (Eski sistemi s√ºr√ºmleri)\nKullanƒ±cƒ±ya Sorulabilecek Sorular:\nUygulama a√ßƒ±lƒ±yor mu, yoksa a√ßƒ±lmadan kapanƒ±yor mu?\nUygulama s√ºr√ºm√º, cihaz i≈ületim sistemi s√ºr√ºm√º nedir? (TVmanager kontrol√º)\nCihazda yeterli depolama alanƒ± var mƒ±?" }
    ],
    "activation": [
        { "title": "‚Äò‚ÄôPromosyon Kodu Bulunamadƒ±‚Äô‚Äô Uyarƒ±sƒ±", "body": "Kampanya kodunun yanlƒ±≈ü, eksik, k√º√ß√ºk harf ya da bo≈üluk bƒ±rakƒ±larak yazƒ±ldƒ±ƒüƒ±nƒ± tespitle, kullanƒ±cƒ±yƒ± bu doƒürultuda doƒüru yazƒ±m i√ßin y√∂nlendirmemiz gerekir." },
        { "title": "‚Äò‚ÄôKampanya Kodu Aktif Edilemedi‚Äô‚Äô Uyarƒ±sƒ±", "body": "Eski bir promosyon kodu yazƒ±ldƒ±ƒüƒ±nda ‚Äò‚ÄôKampanya Kodu Aktif Edilemedi‚Äô‚Äô uyarƒ±sƒ± alƒ±nƒ±r." },
        { "title": "‚Äò‚ÄôGe√ßersiz Kampanya Kodu‚Äô‚Äô Uyarƒ±sƒ±", "body": "Daha √∂nce kullanƒ±lmƒ±≈ü bir promosyon kodu yazƒ±ldƒ±ƒüƒ±nda ‚Äò‚ÄôGe√ßersiz Kampanya Kodu‚Äô‚Äô hatasƒ± alƒ±nƒ±r." },
        { "title": "Aktivasyon Sorunlarƒ± (Play Store / App Store)", "body": "Kullanƒ±cƒ±larƒ±n mobil maƒüazalar √ºzerinden yaptƒ±ƒüƒ± alƒ±mlarda aktivasyon sorunu ya≈üanmasƒ± durumunda uygulama i√ßinden manuel paket aktivasyonu yapmalarƒ± istenir.\nGmail/Apple kimliƒüi hesabƒ± aktivasyon anƒ±nda a√ßƒ±k olmalƒ±dƒ±r.\nMindbehind 'paketgoogle' veya 'paketapple' kƒ±sayollarƒ± kullanƒ±labilir." }
    ]
};

async function openTechArea(tab) {
    const wrap = document.getElementById('tech-fullscreen');
    if (!wrap) return;
    wrap.style.display = 'flex';
    document.body.classList.add('fs-open');
    document.body.style.overflow = 'hidden';

    const av = document.getElementById('x-side-avatar');
    const nm = document.getElementById('x-side-name');
    const rl = document.getElementById('x-side-role');
    if (av) av.innerText = (currentUser || 'U').trim().slice(0, 1).toUpperCase();
    if (nm) nm.innerText = currentUser || 'Kullanƒ±cƒ±';
    if (rl) rl.innerText = isAdminMode ? 'Admin' : 'Temsilci';

    try { renderTechSections(); } catch (e) { }
    switchTechTab(tab || 'broadcast');
}

function closeFullTech() {
    const wrap = document.getElementById('tech-fullscreen');
    if (wrap) wrap.style.display = 'none';
    document.body.classList.remove('fs-open');
    document.body.style.overflow = '';
}

function switchTechTab(tab) {
    document.querySelectorAll('#tech-fullscreen .q-nav-item').forEach(i => i.classList.remove('active'));
    const byData = document.querySelector(`#tech-fullscreen .q-nav-item[data-tech-tab="${tab}"]`);
    if (byData) { byData.classList.add('active'); }
    else {
        document.querySelectorAll('#tech-fullscreen .q-nav-item').forEach(i => {
            const oc = (i.getAttribute('onclick') || '');
            if (oc.includes(`'${tab}'`) || oc.includes(`\"${tab}\"`)) i.classList.add('active');
        });
    }
    document.querySelectorAll('#tech-fullscreen .q-view-section').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(`x-view-${tab}`);
    if (el) el.classList.add('active');

    if (tab === 'wizard') { renderTechWizardInto('x-wizard-content'); }
    else if (tab.includes('-docs')) { renderTechDocs(); }
}

function renderTechSections() {
    const techCards = (database || []).filter(c => String(c.category || '').toLowerCase() === 'teknik');
    const buckets = { broadcast: [], access: [], app: [], activation: [], cards: [] };
    techCards.forEach(c => {
        const hay = `${c.title || ''} ${c.text || ''} ${c.script || ''}`.toLowerCase();
        if (hay.includes('yayƒ±n') || hay.includes('don') || hay.includes('buffer') || hay.includes('tv')) buckets.broadcast.push(c);
        else if (hay.includes('eri≈üim') || hay.includes('vpn') || hay.includes('login') || hay.includes('yurtdƒ±≈üƒ±')) buckets.access.push(c);
        else if (hay.includes('app') || hay.includes('uygulama') || hay.includes('hata')) buckets.app.push(c);
        else if (hay.includes('aktivasyon') || hay.includes('satƒ±n') || hay.includes('√∂deme')) buckets.activation.push(c);
        else buckets.broadcast.push(c);
        buckets.cards.push(c);
    });
    window.__techBuckets = buckets;

    const bindSearch = (inputId, key, listId) => {
        const inp = document.getElementById(inputId);
        if (!inp) return;
        inp.oninput = () => renderTechList(listId, window.__techBuckets[key].filter(c => (`${c.title} ${c.text} ${c.script}`).toLowerCase().includes(inp.value.toLowerCase())));
    };
    ['broadcast', 'access', 'app', 'activation', 'cards'].forEach(k => {
        bindSearch(`x-search-${k}`, k, `x-${k}-list`);
        renderTechList(`x-${k}-list`, buckets[k]);
    });
    renderTechDocs();
}

function renderTechList(targetId, list, showCategory = false) {
    const el = document.getElementById(targetId);
    if (!el) return;
    if (!list || list.length === 0) { el.innerHTML = '<div style="padding:16px;opacity:.7">ƒ∞√ßerik yok.</div>'; return; }
    el.innerHTML = list.map((c) => `
      <div class="news-item" style="cursor:pointer" onclick="showCardDetail(${JSON.stringify(c).replace(/</g, '\u003c')})">
        <span class="news-title">${escapeHtml(c.title || '')}</span>
        ${showCategory ? `<span class="news-tag">${escapeHtml(c.category || '')}</span>` : ''}
        <div class="news-desc" style="white-space:pre-line">${escapeHtml(c.text || '')}</div>
        ${c.script ? `<div class="script-box" style="margin-top:10px"><b>Script:</b><div style="margin-top:6px;white-space:pre-line">${escapeHtml(c.script || '')}</div><div style="text-align:right;margin-top:10px"><button class="btn btn-copy" onclick="event.stopPropagation(); copyText('${escapeForJsString(c.script || '')}')">Kopyala</button></div></div>` : ''}
      </div>`).join('');
}

function renderTechDocs() {
    const map = { broadcast: 'x-broadcast-docs', access: 'x-access-docs', app: 'x-app-docs', activation: 'x-activation-docs' };
    Object.keys(map).forEach(key => {
        const el = document.getElementById(map[key]);
        if (!el) return;
        const items = TECH_DOC_CONTENT[key] || [];
        if (items.length === 0) { el.innerHTML = '<div style="padding:12px 2px;opacity:.7">D√∂k√ºman bulunamadƒ±.</div>'; return; }
        el.innerHTML = items.map((it, idx) => `
            <div class="doc-card">
              <button type="button" class="doc-head" onclick="toggleDocAccordion(this)">
                <span class="doc-title">${escapeHtml(it.title)}</span><i class="fas fa-chevron-down"></i>
              </button>
              <div class="doc-body" style="display:none; white-space:pre-line">${escapeHtml(it.body)}</div>
            </div>`).join('');
    });
}

function toggleDocAccordion(btn) {
    const card = btn.closest('.doc-card');
    const body = card.querySelector('.doc-body');
    const isOpen = body.style.display !== 'none';
    body.style.display = isOpen ? 'none' : 'block';
    card.classList.toggle('open', !isOpen);
}

function renderTechWizardInto(targetId) {
    const box = document.getElementById(targetId);
    if (!box) return;
    window.embeddedTwState = window.embeddedTwState || { currentStep: 'start', history: [] };
    if (!techWizardData || Object.keys(techWizardData).length === 0) {
        box.innerHTML = '<div style="padding:16px;opacity:.7">Sihirbaz y√ºkleniyor...</div>';
        loadTechWizardData().then(() => renderTechWizardInto(targetId));
        return;
    }
    embeddedTwRender(targetId);
}

function embeddedTwRender(targetId) {
    const box = document.getElementById(targetId);
    if (!box) return;
    const st = window.embeddedTwState;
    const stepData = techWizardData[st.currentStep];
    if (!stepData) { box.innerHTML = `<div class="tech-alert">Hata: Adƒ±m bulunamadƒ± (${st.currentStep}).</div>`; return; }

    let html = `<div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap">
        <div style="display:flex; gap:8px; align-items:center">
          ${st.history.length > 0 ? `<button type="button" class="tech-btn tech-btn-option" onclick="embeddedTwBack('${targetId}')">‚¨Ö Geri</button>` : ''}
          <button type="button" class="tech-btn tech-btn-option" onclick="embeddedTwReset('${targetId}')">‚Üª Sƒ±fƒ±rla</button>
        </div>
        <div style="opacity:.7; font-size:.9rem">Adƒ±m: ${escapeHtml(stepData.title || '')}</div>
      </div><div class="tech-step-title">${escapeHtml(stepData.title || '')}</div>`;

    if (stepData.text) html += `<div style="font-size:1rem; margin:10px 0; white-space:pre-line">${escapeHtml(stepData.text)}</div>`;
    if (stepData.script) html += `<div class="tech-script-box"><span class="tech-script-label">M√º≈üteriye iletilecek:</span>${escapeHtml(stepData.script)}</div>`;
    if (stepData.alert) html += `<div class="tech-alert">${escapeHtml(stepData.alert)}</div>`;
    if (Array.isArray(stepData.buttons)) {
        html += `<div class="tech-buttons-area">${stepData.buttons.map(btn => `<button type="button" class="tech-btn ${btn.style === 'option' ? 'tech-btn-option' : 'tech-btn-primary'}" onclick="embeddedTwChangeStep('${targetId}','${escapeForJsString(btn.next || 'start')}')">${escapeHtml(btn.text)}</button>`).join('')}</div>`;
    }
    box.innerHTML = html;
}

function embeddedTwChangeStep(targetId, newStep) {
    window.embeddedTwState.history.push(window.embeddedTwState.currentStep);
    window.embeddedTwState.currentStep = newStep;
    embeddedTwRender(targetId);
}
function embeddedTwBack(targetId) {
    if (window.embeddedTwState.history.length) { window.embeddedTwState.currentStep = window.embeddedTwState.history.pop(); embeddedTwRender(targetId); }
}
function embeddedTwReset(targetId) {
    window.embeddedTwState = { currentStep: 'start', history: [] };
    embeddedTwRender(targetId);
}

async function loadTechWizardData() {
    try {
        const data = await apiCall("getTechWizardData");
        if (data.result === "success" && data.steps) { techWizardData = data.steps; }
        else { techWizardData = {}; }
    } catch (e) { techWizardData = {}; }
}

async function loadWizardData() {
    try {
        const data = await apiCall("getWizardData");
        if (data.result === "success" && data.steps) { wizardStepsData = data.steps; }
        else { wizardStepsData = {}; }
    } catch (e) { wizardStepsData = {}; }
}

async function openWizard() {
    Swal.fire({ title: 'Y√ºkleniyor...', didOpen: () => { Swal.showLoading() } });
    await loadWizardData();
    Swal.close();
    if (!wizardStepsData || Object.keys(wizardStepsData).length === 0) { Swal.fire('Hata', 'ƒ∞ade verileri alƒ±namadƒ±.', 'error'); return; }

    window.wizardState = { currentStep: 'start', history: [] };
    Swal.fire({
        title: ' ü§ñ  S Sport Plus - ƒ∞ade Asistanƒ±',
        html: '<div id="wizard-content" class="tech-wizard-card"></div>',
        width: '700px', showCloseButton: true, showConfirmButton: false,
        didOpen: () => { renderWizardStep(); },
        willClose: () => { wizardStepsData = {}; }
    });
}

function renderWizardStep() {
    const container = document.getElementById('wizard-content');
    if (!container) return;
    const ws = window.wizardState;
    const stepData = wizardStepsData[ws.currentStep];
    if (!stepData) { container.innerHTML = '<p>Adƒ±m bulunamadƒ±.</p>'; return; }

    let html = `<div class="tech-step-title">${stepData.title}</div>`;
    if (stepData.text) html += `<div style="font-size:1.1rem; margin-bottom:15px; white-space:pre-line;">${stepData.text}</div>`;
    if (stepData.script) html += `<div class="tech-script-box"><span class="tech-script-label">M√º≈üteriye iletilecek:</span>${stepData.script}</div>`;
    if (stepData.alert) html += `<div class="tech-alert"><i class="fas fa-exclamation-triangle"></i> ${stepData.alert}</div>`;
    if (stepData.buttons && stepData.buttons.length) {
        html += `<div class="tech-buttons-area">`;
        stepData.buttons.forEach(btn => {
            let cls = btn.style === 'option' ? 'tech-btn-option' : 'tech-btn-primary';
            html += `<button class="tech-btn ${cls}" onclick="changeWizardStep('${escapeForJsString(btn.next)}')">${btn.text}</button>`;
        });
        html += `</div>`;
    }
    html += `<div style="margin-top:20px; display:flex; gap:10px;">
        <button class="tech-btn tech-btn-option" style="flex:1;" onclick="goBackWizard()" ${ws.history.length === 0 ? 'disabled style="opacity:0.5; cursor:default;"' : ''}>Geri</button>
        <button class="tech-btn tech-btn-option" style="flex:1;" onclick="resetWizard()">Sƒ±fƒ±rla</button>
    </div>`;
    container.innerHTML = html;
}

function changeWizardStep(nextStep) {
    if (nextStep === 'null' || !nextStep) return;
    window.wizardState.history.push(window.wizardState.currentStep);
    window.wizardState.currentStep = nextStep;
    renderWizardStep();
}
function goBackWizard() {
    if (window.wizardState.history.length > 0) { window.wizardState.currentStep = window.wizardState.history.pop(); renderWizardStep(); }
}
function resetWizard() {
    window.wizardState = { currentStep: 'start', history: [] };
    renderWizardStep();
}

async function openTechWizard() {
    Swal.fire({ title: 'Y√ºkleniyor...', didOpen: () => { Swal.showLoading() } });
    await loadTechWizardData();
    Swal.close();
    if (!techWizardData || Object.keys(techWizardData).length === 0) { Swal.fire('Hata', 'Sihirbaz verileri alƒ±namadƒ±.', 'error'); return; }

    twState = { currentStep: 'start', history: [] };
    const { value: ignore } = await Swal.fire({
        title: ' üõ†Ô∏è  Teknik √á√∂z√ºm Sihirbazƒ±',
        html: '<div id="tw-content" class="tech-wizard-card"></div>',
        width: '700px', showCloseButton: true, showConfirmButton: false,
        didOpen: () => { twRenderStep(); },
        willClose: () => { techWizardData = {}; }
    });
}

function twRenderStep() {
    const container = document.getElementById('tw-content');
    if (!container) return;
    const stepData = techWizardData[twState.currentStep];
    if (!stepData) { container.innerHTML = '<p>Adƒ±m bulunamadƒ±.</p>'; return; }

    let html = `<div class="tech-step-title">${stepData.title}</div>`;
    if (stepData.text) html += `<div style="font-size:1.1rem; margin-bottom:15px; white-space:pre-line;">${stepData.text}</div>`;
    if (stepData.script) html += `<div class="tech-script-box"><span class="tech-script-label">M√º≈üteriye iletilecek:</span>${stepData.script}</div>`;
    if (stepData.alert) html += `<div class="tech-alert"><i class="fas fa-exclamation-triangle"></i> ${stepData.alert}</div>`;
    if (stepData.buttons && stepData.buttons.length) {
        html += `<div class="tech-buttons-area">`;
        stepData.buttons.forEach(btn => {
            let cls = btn.style === 'option' ? 'tech-btn-option' : 'tech-btn-primary';
            html += `<button class="tech-btn ${cls}" onclick="twChangeStep('${escapeForJsString(btn.next)}')">${btn.text}</button>`;
        });
        html += `</div>`;
    }
    html += `<div style="margin-top:20px; display:flex; gap:10px;">
        <button class="tech-btn tech-btn-option" style="flex:1;" onclick="twGoBack()" ${twState.history.length === 0 ? 'disabled style="opacity:0.5; cursor:default;"' : ''}>Geri</button>
        <button class="tech-btn tech-btn-option" style="flex:1;" onclick="twResetWizard()">Sƒ±fƒ±rla</button>
    </div>`;
    container.innerHTML = html;
}

function twChangeStep(nextStep) {
    if (nextStep === 'null' || !nextStep) return;
    twState.history.push(twState.currentStep);
    twState.currentStep = nextStep;
    twRenderStep();
}
function twGoBack() {
    if (twState.history.length > 0) { twState.currentStep = twState.history.pop(); twRenderStep(); }
}
function twResetWizard() {
    twState = { currentStep: 'start', history: [] };
    twRenderStep();
}
